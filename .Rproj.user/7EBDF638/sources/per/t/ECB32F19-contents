# setwd("~/Boston University/Dissertation/nbTransmission")

library(devtools)
library(roxygen2)
library(testthat)
library(pkgdown)
library(dplyr)

#Loading package
load_all()

#### Hamburg example for testing ####

set.seed(10489)

## Setting up the datasets
hamInd <- readRDS("C:/Users/ashap/Downloads/HamburgInd.rds")
hamPair <- readRDS("C:/Users/ashap/Downloads/HamburgPair.rds")

hamPair <- hamPair %>% mutate(snpClose = ifelse(snpDist < 2, TRUE,
                                                ifelse(snpDist > 12, FALSE, NA)))

orderedHam_my <- hamPair[(hamPair$IsolationDiff >0 & !is.na(hamPair$IsolationDiff)), ]

orderedHam_my <- orderedHam_my %>% rename(edgeID2 = edgeID)

orderedPair <- orderedHam_my
dateVar <- "IsolationDate"
indIDVar <- "individualID"
pairIDVar <- "edgeID2"
goldStdVar <- "snpClose"
pVar <- "pScaled"
label <- "Ham"
nbWeighting <- FALSE
n <- 10
m <- 1
nReps <- 1

covariates <- c("Study", "Nationality", "Sex", "Age", "SmearPos", "HIV",
                "SubstanceAbuse", "Residence", "Milieu", "TimeCat")


# Estimating probabilities and ORs using my method
resHam <- nbProbabilities(orderedPair = orderedHam_my, indIDVar = "individualID",
                          pairIDVar = "edgeID2", goldStdVar = "SameGroup",
                          covariates = covariates, label = "HamCont",
                          n = 10, m = 1, nReps = 5)

# Estimating probabilities and ORs using Annie's method
resHam_adjust <- nbProbabilities(orderedPair = orderedHam_my, indIDVar = "individualID",
                                 pairIDVar = "edgeID2", goldStdVar = "SameGroup",
                                 covariates = covariates, label = "HamCont",
                                 n = 10, m = 1, nReps = 5, orType = "adjusted", nBS = 10)
